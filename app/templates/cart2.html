{% extends 'base.html' %}

{% block title %} Cart {% endblock %}

{% block body %}

<div class="container my-5">
    <div class="row">
        {% if cart %}

        <h1 class="text-center mb-5" style="color: info;">Shopping Cart</h1>
        <div class="col-sm-8">
            <div class="card">
                <div class="card-body">

                    {% for item in cart %}
                    <!-- Cart item rendering goes here -->
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-sm-4">
            <div class="card">
                <div class="card-body">
                    <h3>Cart Summary </h3>
                    <hr color="black">
                    <ul class="list-group">
                        {% for item in cart %}
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                            <strong>{{item.product.product_name}}</strong>
                            <span id="amount">{{item.product.current_price}} X <span id="quantity{{item.id}}">{{ item.quantity }}</span></span>
                        </li>
                        {% endfor %}

                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                            Amount <span>Ksh <span id="amount_tt">{{ amount }}</span></span>
                        </li>

                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                            <div style="margin-top: 15px;">
                                <strong>Total</strong>
                                <small>(Including Shipping)</small>
                            </div>
                            <span><strong>Ksh </strong><span id="totalamount"><strong>{{ total }}</strong></span></span>
                        </li>
                    </ul>

                    <div class="d-grid">
                        <br>
                        <!-- Airtel payment form -->
                        <form action="{{ url_for('views.handle_airtel') }}" method="POST">
                            <!-- Airtel form fields -->
                        </form>
                        <br>

                        <!-- M-Pesa Payment Form -->
                        <form id="mpesa-form">
                            <input type="text" name="phone_number" placeholder="Enter M-Pesa Phone Number" required>
                            <input type="text" name="amount" value="{{ total }}">
                            <button type="submit" class="btn btn-success btn-block">Pay with M-Pesa</button>
                        </form>
                        <div id="mpesa-response"></div> <!-- Display success/error messages here -->
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <h1 class="text-center mb-5" style="color: white;">Your Cart is Empty</h1>
        {% endif %}
    </div>
</div>

{% endblock %}

<script>
document.getElementById("mpesa-form").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevent form submission
    
    const form = event.target;
    const phoneNumber = form.querySelector("input[name='phone_number']").value;
    const amount = form.querySelector("input[name='amount']").value;
    
    const requestData = {
        phone_number: phoneNumber,
        amount: amount
    };

    fetch("/mpesa/stk_push", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("mpesa-response").innerHTML = `
                <div class="alert alert-success">
                    ${data.message} <br>
                    Checkout Request ID: ${data.CheckoutRequestID}
                </div>
            `;
        } else {
            document.getElementById("mpesa-response").innerHTML = `
                <div class="alert alert-danger">
                    ${data.error || 'Payment failed. Please try again.'}
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById("mpesa-response").innerHTML = `
            <div class="alert alert-danger">
                An error occurred while processing your payment. Please try again later.
            </div>
        `;
        console.error("Error during STK Push request:", error);
    });
});
</script>

